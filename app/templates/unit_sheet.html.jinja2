{% if not request.headers.hx_request %}
{% extends "layout.html.jinja2" %}
{% block title %}{{ unit_data.name }} &mdash; Units | {% endblock %}
{% endif %}
{% block content %}
<div id="unitSheet">
  <div class="unit-head-container">
    <div class="div1"><img src="/static/images/portraits/{{ unit_data.portrait_nid|urlencode }}.png" /></div>
    <div class="div2">
      <hgroup>
        <h2>{{ unit_data.name }}</h2>
        <p>{{ unit_data.desc }}</p>
      </hgroup>
    </div>
  </div>
  <br />

  <div class="unit-head-container">
    <div class="div1">
      <img
        src="{{ url_for('static',filename='images/map_sprites/'+unit_data.base_class_data.map_sprite_nid+'-stand.webp') }}"
        height="96" width="96" />
    </div>
    <div class="div2">
      <hgroup>
        <h3>{{ unit_data.base_class_data.name }}</h3>
        <p>{{ unit_data.base_class_data.desc }}
          {% if unit_data.base_class_data.weapons%}
          <br />
          <span class="lt-color-red">Prof:</span>
          {% for weapon_type in unit_data.base_class_data.weapons%}
          <span class=" Wexpicons-icon {{ weapon_type }}-subIcon"></span>
          {% endfor %}
          {% endif %}
        </p>
      </hgroup>
    </div>
  </div>

  <div class="overflow-auto">
    <table class="striped">
      {% set stat_names = ('HP','STR','MAG','SKL','SPD','LCK','DEF','RES','CON','MOV') %}
      <thead>
        <tr>
          <th scope="col">Stat</th>
          {% for stat_name in stat_names %}
          <th scope="col">{{ stat_name }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        <tr>
          <th scope="row">Base</th>
          {% for stat_name in stat_names[:-1] %}
          <td>{{ unit_data.base_class_data.promotion[stat_name] + unit_data.bases[stat_name] }}</td>
          {% endfor %}
          <td>{{ unit_data.base_class_data.bases['MOV'] }}</td>
        </tr>
        <tr>
          <th scope="row">Growth</th>
          {% for stat_name in stat_names %}
          <td>{{ unit_data.base_class_data.growth_bonus[stat_name] + unit_data.growths[stat_name] }}%</td>
          {% endfor %}
        </tr>
        <tr>
          <th scope="row">Cap</th>
          {% for stat_name in stat_names %}
          <td>{{ unit_data.base_class_data.max_stats[stat_name] + unit_data.stat_cap_modifiers[stat_name]}}</td>
          {% endfor %}
        </tr>
    </table>
  </div>

  {% if unit_data.learned_skills or unit_data.base_class_data.learned_skills%}
  <details open>
    <summary>Skills</summary>
    <div class="grid">
      {% for skill_lvl,skill_nid in unit_data.learned_skills %}

      <div hx-get=/skills/{{skill_nid}} hx-trigger=" load" hx-target="this" hx-swap="outerHTML">
      </div>

      {% endfor %}

      {% for skill_lvl,skill_nid in unit_data.base_class_data.learned_skills %}
      {% if skill_lvl > 1 %}
      <div>
        <p>Level {{skill_lvl}}</p>
        <div hx-get=/skills/{{skill_nid}} hx-trigger=" load" hx-target="this" hx-swap="outerHTML">
        </div>
      </div>
      {% endif %}
      {% endfor %}
    </div>
  </details>
  <hr />
  {% endif %}

  <details>
    <summary>Promotions</summary>
    {% if unit_data.base_class_data.tier == 0 %}
    <div id="classT1Selector">
      <label>Tier 1</label>
      {% if unit_promos.turns_into|length > 1%}
      <select class="unitClassSelect" name="unitClassSelect" aria-label="Select unit" required
        hx-get="/units/{{ unit_data.nid }}/classes" hx-target="#unitClassT1Sheet" hx-indicator="#unitClassT1Sheet"
        hx-swap="innerHTML"
        _="on change set #unitClassT3Sheet.innerHTML to '' then set #unitClassT2Sheet.innerHTML to ''">
        <option value="default" selected disabled>Select a tier 1 class</option>
        {% for promo_class_t2 in unit_promos.turns_into %}
        <option value="{{ promo_class_t2.nid }}">{{ promo_class_t2.name }}</option>
        {% endfor %}
      </select>
      {% else %}
      {% set promo_class_t2=unit_promos.turns_into|first%}
      <div hx-vals='{"unitClassSelect":"{{ promo_class_t2.nid }}"}' hx-get="/units/{{ unit_data.nid }}/classes"
        hx-target="#unitClassT1Sheet" hx-indicator="#unitClassT1Sheet" hx-swap="innerHTML" hx-trigger="load"></div>
      {% endif %}
    </div>
    {% else %}
    <div id="classT2Selector">
      <label>Tier 2</label>
      {% if unit_promos.turns_into|length > 1%}
      <select class="unitClassSelect" name="unitClassSelect" aria-label="Select unit" required
        hx-get="/units/{{ unit_data.nid }}/classes" hx-target="#unitClassT2Sheet" hx-indicator="#unitClassT2Sheet"
        hx-swap="innerHTML" _="on change set #unitClassT3Sheet.innerHTML to ''">
        <option value="default" selected disabled>Select a tier 2 class</option>
        {% for promo_class_t2 in unit_promos.turns_into%}
        <option value="{{ promo_class_t2.nid }}">{{ promo_class_t2.name }}</option>
        {% endfor %}
      </select>
      {% else %}
      {% set promo_class_t2=unit_promos.turns_into|first%}
      <div hx-vals='{"unitClassSelect":"{{ promo_class_t2.nid }}"}' hx-get="/units/{{ unit_data.nid }}/classes"
        hx-target="#unitClassT2Sheet" hx-indicator="#unitClassT2Sheet" hx-swap="innerHTML" hx-trigger="load"></div>
      {% endif %}
    </div>
    {% endif %}
    <div id="unitClassT1Sheet"></div>
    <div id="unitClassT2Sheet"></div>
    <div id="unitClassT3Sheet"></div>
  </details>
  <hr />

  {% if unit_data.starting_items %}
  <details>
    <summary>Starting Items</summary>
    <div class="grid">
      {% for item_nid in unit_data.starting_items %}
      <div>
        <div hx-get=/items/{{item_nid}} hx-trigger=" load" hx-target="this" hx-swap="outerHTML">
        </div>
      </div>
      {% endfor %}
    </div>
  </details>
  <hr />
  {% endif %}

  {% if unit_supports %}
  <details>
    <summary>Supports</summary>
    <ul>
      {% for support_nid,support_data in unit_supports|items %}
      <li>
        <details name="example">
          <summary>
            <a href="#" hx-get="/units/{{ support_nid }}" hx-vals='{"addCopy": "True"}' hx-target="#unitSheet">{{
              support_data.name }}</a>
            <span class="Affinity-icon Pair-up-affinity-{{ support_data.affinity.nid|lower }}-icon"></span>
          </summary>
          <div class="overflow-auto">
            <table class="striped">
              <thead>
                <tr>
                  {% for stat, stat_val in support_data.affinity.bonus[0]|items %}
                  {% if stat == "RANK" or stat_val > 0.0 %}
                  <th scope="col">{{ stat }}</th>
                  {% endif %}
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for bonus_data in support_data.affinity.bonus %}
                <tr>
                  {% for stat, stat_val in bonus_data|items %}
                  {% if stat != "RANK" and stat_val > 0.0 %}
                  <td>+{{ stat_val }}</td>
                  {% elif stat == "RANK"%}
                  <th scope="row">{{ stat_val }}</th>
                  {% endif %}
                  {% endfor %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </details>
      </li>
      {% endfor %}
    </ul>
  </details>
  {% endif %}
</div>
{% endblock content %}